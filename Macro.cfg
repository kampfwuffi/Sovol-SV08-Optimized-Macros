[gcode_macro BEEP]
description: AUDIO BEEP (COUNT=1 → ONE BEEP, COUNT=3 → 3 BEEPS, ...)
gcode:
    {% set count = params.COUNT|default(1)|int %}
    {% set dur   = params.D|default(240)|int %}    ; duration of one note in ms

    {% if count == 1 %}
        ; single short beep (old behaviour)
        SET_PIN PIN=beeper VALUE=1
        G4 P{dur}
        SET_PIN PIN=beeper VALUE=0

    {% elif count == 3 %}
        ; short happy success melody (♪♪♪)
        SET_PIN PIN=beeper VALUE=1
        G4 P90
        SET_PIN PIN=beeper VALUE=0
        G4 P110

        SET_PIN PIN=beeper VALUE=1
        G4 P90
        SET_PIN PIN=beeper VALUE=0
        G4 P140

        SET_PIN PIN=beeper VALUE=1
        G4 P280
        SET_PIN PIN=beeper VALUE=0

    {% else %}
        ; any other count → classic repeated beeps
        {% for i in range(count) %}
            SET_PIN PIN=beeper VALUE=1
            G4 P{dur}
            SET_PIN PIN=beeper VALUE=0
            G4 P100
        {% endfor %}
    {% endif %}

[gcode_macro mainled_on]
description: TURNS THE MAIN LED ON
gcode:
    SET_PIN PIN=main_led VALUE=1

[gcode_macro mainled_off]
description: TURNS THE MAIN LED OFF
gcode:
    SET_PIN PIN=main_led VALUE=0

#--------------------------------------------------------------------#
#--------------------------------------------------------------------#

[gcode_shell_command FACTORY_RESETS]
command: /home/sovol/factory_resets.sh
timeout: 2.

[force_move]
enable_force_move: True # WARNING: Force moves can crash the toolhead if not used carefully).

[gcode_macro _global_var]
description: DEFINES GLOBAL VARIABLES FOR MANY SETTINGS USED ACROSS MACROS
variable_pause_park: {'x': 0, 'y': 0, 'z': 10, 'e': 1}
variable_cancel_park: {'x': 0, 'y': 350, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 345 ; SV08 default do not change
variable_pause_resume_travel_speed: 150 ; SV08 default do not change
variable_preheat_temp: 150 ; nozzle preheat temp during z-offset, QGL, bed mesh, ...
variable_load_filament_extruder_temp: 235 ; nozzle extrusion temperature for filament (un)load, cleaning blob,... (_SET_TEMPERATURE)
variable_bed_mesh_calibrate_target_temp: 67 ; bed temp for calibrations, (_SET_TEMPERATURE)
variable_calibrate_bed_temp: 64 ; CLEANING: bed temp for nozzle cleaning. Lower temp = less sticky cleaning blob (_SET_TEMPERATURE)
variable_clean_blob_extrusion_height: 1.2 ; CLEANING: base height cleaning blob extrusions (default 1.2 mm). Lower is more sticky poop.
variable_post_print_fan_speed: 0.75 ; additional nozzle cooling fan speed after print finished / canceled (0.75 default)
variable_post_print_cool_time: 25000 ; additional nozzle cooling fan duration after print finished /canceled (ms)
variable_timeout_extruder: 600000 ; 10 minute timeout extruder heating (additional safety)
variable_timeout_bed: 900000 ; 15 minute timeout bed heating (additional safety)
gcode:

[gcode_macro _IDLE_TIMEOUT]
description: HANDLES IDLE TIMEOUT BY TURNING OFF HEATERS AND MOTORS IF NOT PAUSED, OR DISPLAYS A MESSAGE IF PAUSED
gcode:
    {% if printer.print_stats.state == "paused" %}
      RESPOND TYPE=echo MSG="IDLE 10MIN!"
    {% else %}
     M84
     TURN_OFF_HEATERS
    {% endif %}

[gcode_macro _ALL_FAN_OFF]
description: TURNS OFF ALL COOLING FANS
gcode:
    M106 S0
    M107
    RESPOND TYPE=echo MSG="FANS OFF!"

[gcode_macro CHECK_FILAMENT_SENSOR]
description: CHECKS FILAMENT SENSOR STATUS AND RETURNS DETECTION STATE (NOT ONLY ONCE PER PRINT)
gcode:
    {% set cancel = True %}
    {% if params.CANCEL is defined and params.CANCEL|lower in ['0', 'false', 'no'] %}
        {% set cancel = False %}
    {% endif %}
    RESPOND TYPE=echo MSG="CHECKING SENSOR (FILAMENT)"
    M117 SENSOR CHECK
    {% if 'filament_switch_sensor filament_sensor' in printer %}
        ; Attempt 1
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
        G4 P1000 ; Reset sensor
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
        G4 P2000 ; Wait 2s for sensor to settle
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        {% set sensor_detected_1 = printer['filament_switch_sensor filament_sensor'].filament_detected %}
        RESPOND TYPE=echo MSG="SENSOR D1: {sensor_detected_1}"
        M117 SENSOR D1 {sensor_detected_1}
        
        ; Attempt 2
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
        G4 P1000
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
        G4 P2000
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        G4 P200
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        {% set sensor_detected_2 = printer['filament_switch_sensor filament_sensor'].filament_detected %}
        RESPOND TYPE=echo MSG="SENSOR D2: {sensor_detected_2}"
        M117 SENSOR D2 {sensor_detected_2}
        
        ; Final state
        {% set sensor_detected = sensor_detected_2 %}
        {% if sensor_detected_1 != sensor_detected_2 %}
            RESPOND TYPE=echo MSG="F-SENSOR ERROR"
            {% set sensor_detected = False %}
        {% endif %}
        
        RESPOND TYPE=echo MSG="SENSOR D3: {sensor_detected}"
        M117 SENSOR D3 {sensor_detected}
        {% if not sensor_detected %}
            RESPOND TYPE=echo MSG="NO FILAMENT!"
            M117 NO FILAMENT!
            LCD_RED
            BEEP COUNT=5
            {% if cancel %}
                RESPOND TYPE=echo MSG="CANCEL: NO FILAMENT!"
                M117 CANCEL: NO FILAMENT!
                CANCEL_PRINT
            {% else %}
                RESPOND TYPE=echo MSG="INSERT FILAMENT!"
                M117 INSERT FILAMENT!
            {% endif %}
        {% else %}
            RESPOND TYPE=echo MSG="FILAMENT OK"
            M117 FILAMENT OK
        {% endif %}
    {% else %}
        RESPOND TYPE=echo MSG="NO SENSOR: FILAMENT OK"
        M117 NO SENSOR: FILAMENT OK
        {% set sensor_detected = True %}
    {% endif %}

[gcode_macro _SET_TEMPERATURE]
description: SETS EXTRUDER AND BED TEMPERATURES WITH OPTIONAL WAIT
gcode:
    {% set extruder_temp = params.EXTRUDER_TEMP|default(-1)|int %}
    {% set bed_temp = params.BED_TEMP|default(-1)|int %}
    {% set wait = params.WAIT|default('true')|lower %}
    {% if extruder_temp == -1 and bed_temp == -1 %}
        {% set extruder_temp = printer['gcode_macro _global_var'].preheat_temp|int %}
        {% set bed_temp = printer['gcode_macro _global_var'].calibrate_bed_temp|int %}
    {% endif %}
    {% if extruder_temp != -1 %}
        RESPOND TYPE=echo MSG="SET EXTRUDER {extruder_temp}°C"
        M104 S{extruder_temp}
    {% endif %}
    {% if bed_temp != -1 %}
        RESPOND TYPE=echo MSG="SET BED {bed_temp}°C"
        M140 S{bed_temp}
    {% endif %}
    {% if wait != 'false' and wait != '0' %}
        {% if extruder_temp != -1 and extruder_temp != 0 %}
            TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp-1} MAXIMUM={extruder_temp+1} TIMEOUT={printer['gcode_macro _global_var'].timeout_extruder}
        {% endif %}
        {% if bed_temp != -1 and bed_temp != 0 %}
            TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp-1} MAXIMUM={bed_temp+1} TIMEOUT={printer['gcode_macro _global_var'].timeout_bed}
        {% endif %}
        {% if (extruder_temp != -1 and extruder_temp != 0) or (bed_temp != -1 and bed_temp != 0) %}
            RESPOND TYPE=echo MSG="TEMP OK {extruder_temp}/{bed_temp}°C"
        {% endif %}
    {% endif %}

[gcode_macro CLEAN_NOZZLE]
description: CLEANS THE NOZZLE AND AVOIDS REMAINING FILAMENT ON BUILD PLATE
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR: GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set bed_temp = printer['gcode_macro _global_var'].calibrate_bed_temp|int %}
    LCD_WHITE
    #NOZZLE_LED_WHITE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
    M117 CLEAN NOZZLE
    RESPOND TYPE=echo MSG="CLEANING START"
    _SET_TEMPERATURE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} WAIT=False
    {% if printer.toolhead.homed_axes != "xyz" %}
        G28
    {% endif %}
    G90  ; Absolute positioning
    CHECK_FILAMENT_SENSOR
    M117 PREPARE CLEAN
    G1 X344 Y308 Z2.6 F7000  ; Move to cleaning spot
    G1 X345 Y315 F7000  ; Move to POOP start position
    M83  ; Relative extruder mode
    G1 Z0.0 F600  ; Lower to clean height
    M117 CLEANING PREHEAT
    LCD_ORANGE
    _SET_TEMPERATURE EXTRUDER_TEMP={extruder_temp} BED_TEMP={bed_temp} WAIT=True
    _SET_TEMPERATURE BED_TEMP=0
    LCD_WHITE
    M117 CLEANING BLOB
    G1 Z{printer["gcode_macro _global_var"].clean_blob_extrusion_height} F400 ; EXTRUDE BLOB height 1
    G1 X349 Y317 F7000
    M400
    TURN_OFF_HEATERS
    G1 E16 F250  ; EXTRUDE BLOB 1
    G90  ; Absolute positioning
    G1 X345 Y315 F7000  ; Move to poop end position
    G1 Z{printer["gcode_macro _global_var"].clean_blob_extrusion_height + 0.3} F300 ; EXTRUDE BLOB height 2
    M83  ; Relative extruder mode
    G1 E32 F250  ; EXTRUDE BLOB 2
    G90  ; Absolute positioning
    G1 Z{printer["gcode_macro _global_var"].clean_blob_extrusion_height + 0.5} F80 ; EXTRUDE BLOB height 3
    M106 S255  ; Fan on
    M83  ; Relative extruder mode
    G1 E14 F250  ; EXTRUDE BLOB 3
    G90  ; Absolute positioning
    M400
    RESPOND TYPE=echo MSG="COOLING FOR KICK"
    M117 CLEANING COOLING
    G4 P5000  ; Wait 5 seconds for partial cooling
    G1 Z2.4 F100  ; Raise to avoid sticking
    G4 P2000  ; Additional cooling wait
    G1 X347 Y315 Z4.5 F16  ; Raise nozzle
    G4 P1000
    M117 CLEANING BRUSH
    G1 Z4.9 F300  ; Wipe height
    G1 X354 Y290 F10000  ; Strings wipe
    M400
    G1 Y260 F10000  ; Strings wipe
    G1 X310 Y359 F10000
    G1 X352 F9000  ; Brush start position
    G1 Z1.0 F300  ; Rip height
    G1 Y360 X310 F10000  ; Wiggle left
    G1 Y356 X354 F10000  ; Wiggle right
    G1 Y360 X310 F10000  ; Wiggle left
    M400
    G1 Z1.1 F300
    G1 Y360 X318 F4500  ; Brush moves
    G1 Y356 X320
    G1 Y360 X322
    G1 Y356 X324
    G1 Y360 X326
    G1 Y356 X328
    G1 Y360 X330
    G1 Y356 X332
    G1 Y360 X334
    G1 Y356 X336
    G1 Y360 X338
    G1 Y356 X340
    G1 Y360 X342
    G1 Y356 X344
    G1 Y360 X346
    G1 Y356 X348
    G1 Y360 X350
    G1 Y356 X352
    G1 Z7.0 F300  ; Wipe height
    M400
    G1 X344 Y314 F7000  ; Park for cooling
    M117 CLEANING COOLING
    G4 P2000
    G1 X342 Y314 Z4.8 F300
    G4 P2000
    G1 Z3.8 F300
    G4 P38000  ; Long cooling wait
    G1 Z7.0 F300
    M400
    M117 CLEANING KICK
    G1 X350 Y260 F10000  ; Strings wipe
    M400
    G1 X345 Y315 F7000  ; Kick end position
    G1 Z2.3 F300  ; Kick height
    M400
    G1 X344 Y314 F3000  ; Loosen
    G1 X346 Y316 F3000
    G1 X345 Y315 F3000
    G1 X351 Y340 F5000  ; Kick poop away
    G1 Z2.4 F300  ; Kick height
    M400
    G1 X353 Y359 F2000  ; Brush start
    M400
    G1 Z2.0 F300  ; Brush height
    G1 Y340 F4000  ; Loosen poop
    G1 Z6.0 F300
    G1 Y359 F4000
    G1 Z2.8 F300
    G1 Y355 X306 F6000  ; Brush wiggle left
    G1 Z9.0 F600  ; Blow away
    G4 P1500
    G1 Z1.6 F300
    G1 Y358 X354 F6000  ; Brush wiggle right
    G1 Z0.9 F300
    G1 Y356 X306 F7000
    G1 Z9.0 F600
    G4 P1500
    G1 Z0.9 F300
    G1 Y354 X354 F7000
    M400
    G1 Z9.0 F600
    G4 P200
    M400
    G1 Z1.0 F600
    G1 Y359 X354 F10000
    G1 Y356 X308 F10000
    M400
    M117 CLEANING BLOW
    G1 Z12.0 F600  ; Blow away
    M400
    G1 Y280 X350 F4000  ; Fan blow circle
    G1 Y240 X240
    G1 Y335 X250
    G1 Y350 X295
    G1 Y270 X340
    G1 Y356 X354
    M400
    M117 CLEANING STAGE2
    G1 Z1.0 F600
    G1 Y359 X310 F9000
    G1 Y358 X350
    G1 Y356 X310 F9000
    M400
    G1 Z6.0 F300
    G1 Y360 X353 F4500
    M117 CLEAN FINISHED
    RESPOND TYPE=echo MSG="CLEANING FINISHED"
    M400
    G90  ; Absolute positioning
    G1 X0 Y0 Z5.0 F9000  ; Move to safe position
    G1 Z0.0 F400  ; Move to safe position
    M400
    M107  ; Stop fan

# MOD Z-OFFSET START
[gcode_macro _CALIBRATION_ZOFFSET]
gcode:
    LCD_YELLOW
    M117 CALIBRATE OFFSET
    {% set homed_status = 'No' if printer.toolhead.homed_axes|lower == '' else printer.toolhead.homed_axes %}
    RESPOND TYPE=echo MSG="_CALIBRATION_ZOFFSET: START, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, STATE={printer.print_stats.state}, HOMED={homed_status}"
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
        RESPOND TYPE=echo MSG="_CALIBRATION_ZOFFSET: POST-G28, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, HOMED={printer.toolhead.homed_axes}"
    {% endif %}
    _SET_TEMPERATURE EXTRUDER_TEMP={printer['gcode_macro _global_var'].preheat_temp} BED_TEMP={printer['gcode_macro _global_var'].calibrate_bed_temp} WAIT=False
    QUAD_GANTRY_LEVEL
    RESPOND TYPE=echo MSG="CAL ZOFFSET: POST QGL, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, HOMED={printer.toolhead.homed_axes}"
    G0 X170 Y170 Z10 F2000
    RESPOND TYPE=echo MSG="CAL ZOFFSET: POST G0 X170 Y170 Z10, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}"
    G4 P500
    CLEAN_NOZZLE
    RESPOND TYPE=echo MSG="CAL ZOFFSET: POST CLEANING, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}"
    G1 Z10 F3000 ; Ensure safe Z height before calibration
    M117 CALIBRATING Z
    _SET_TEMPERATURE EXTRUDER_TEMP={printer['gcode_macro _global_var'].preheat_temp} BED_TEMP={printer['gcode_macro _global_var'].calibrate_bed_temp} WAIT=False
    Z_OFFSET_CALIBRATION
    G1 Z10 F3000 ; Move to safe Z height post-calibration
    RESPOND TYPE=echo MSG="CAL ZOFFSET: POST Z-CALIBRATION, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, STATE={printer.print_stats.state}, BED_MESH_PROFILE={printer.bed_mesh.profile_name|default('N/A')}"

[delayed_gcode _auto_zoffset]
gcode:
    SAVE_VARIABLE VARIABLE=offsetadjust VALUE={'%05.2f' % (0)}
    {% set homed_status = 'No' if printer.toolhead.homed_axes|lower == '' else printer.toolhead.homed_axes %}
    RESPOND TYPE=echo MSG="AUTO ZOFFSET START, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, STATE={printer.print_stats.state}, HOMED={homed_status}"
    G28 ; Ensure homing
    _CALIBRATION_ZOFFSET
    G28 ; Re-home before test print
    G90
    G1 X170 Y170 Z10 F3000 ; Safe position
    _SET_TEMPERATURE EXTRUDER_TEMP={printer['gcode_macro _global_var'].preheat_temp} BED_TEMP={printer['gcode_macro _global_var'].calibrate_bed_temp} WAIT=True
    M23 /.zoffset_test.gcode
    RESPOND TYPE=echo MSG="AUTO ZOFFSET POST M23, FILE=/.zoffset_test.gcode, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, STATE={printer.print_stats.state}"
    M24
    RESPOND TYPE=echo MSG="AUTO ZOFFSET POST M24, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, STATE={printer.print_stats.state}"

[gcode_macro _Delay_Calibrate]
gcode:
    UPDATE_DELAYED_GCODE ID=_auto_zoffset DURATION=1.0
# MOD Z-OFFSET END

#MOD DISPLAY AND CONSOLE START
[gcode_macro DISPLAY_Z_OFFSET]
description: DISPLAYS Z-OFFSET ON LCD ON STARTUP AND LOGS TO CONSOLE, CHANGES LED DISPLAY TO RED IF VALUE TOO HIGH (NOZZLE SCRATCHING BED)
gcode:
    {% set z_height = printer.configfile.settings.probe.z_offset|float|round(3) %}
    {% if z_height >= 2.0 %}
        RESPOND TYPE=echo MSG="Z-OFFSET {z_height}!"
        RESPOND TYPE=echo MSG="Z-OFFSET INVALID MAY SCRATCH BED!"
        M117 Z-OFFSET: {z_height}!
        LCD_RED
    {% else %}
        RESPOND TYPE=echo MSG="Z-OFFSET: {z_height}"
        M117 Z-OFFSET: {z_height}
        LCD_GREEN
    {% endif %}

[delayed_gcode SHOW_Z_OFFSET_ON_STARTUP]
initial_duration: 4.0
gcode:
    DISPLAY_Z_OFFSET

[gcode_macro DISPLAY_IP_ADDRESS] #Macro to display the IP address on LCD only
description: DISPLAYS THE IP ADDRESS OF THE PRINTER ON LCD ON STARTUP
gcode:
    RESPOND TYPE=echo MSG="GETTING IP LCD"
    _GET_IP

[delayed_gcode SHOW_IP_ADDRESS_ON_STARTUP]
initial_duration: 10.0
gcode:
    DISPLAY_IP_ADDRESS

[delayed_gcode CHECK_RESUME_ON_BOOT]
initial_duration: 12.0
gcode:
    {% set interrupted = printer.save_variables.variables.was_interrupted|default(False) %}

    {% if interrupted == True %}
        M117 RESUME? CANCEL?
        LCD_RED
        RESPOND TYPE=echo MSG="RESUME PENDING! Power loss detected. Use LCD menu: Resume or Cancel"
        BEEP COUNT=8
    {% else %}
        RESPOND TYPE=echo MSG="No pending print due to power loss."
    {% endif %}
# MOD DISPLAY AND CONSOLE END

[delayed_gcode TEST_BELT]
initial_duration: 0.3
gcode:
    {% set x_freq = printer.save_variables.variables.x_freq|float %}
    {% set y_freq = printer.save_variables.variables.y_freq|float %}
    {% set show_freq = printer.save_variables.variables.show_freq %}
    {% if show_freq == 1 %}
        RESPOND TYPE=echo MSG="INPUT SHAPING"
        LCD_YELLOW
        #NOZZLE_LED_PURPLE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
        M117 x {x_freq}, y {y_freq}
        SAVE_VARIABLE VARIABLE=show_freq VALUE=0
    {% endif %}

[gcode_macro QUAD_GANTRY_LEVEL]
description: PERFORMS QUAD GANTRY LEVELING WITH PREHEATING AND Z-AXIS RE-HOMING
rename_existing: QUAD_GANTRY_LEVEL_BASE
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR: GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    LCD_YELLOW
    #NOZZLE_LED_PURPLE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].calibrate_bed_temp|int %}
    _SET_TEMPERATURE EXTRUDER_TEMP={printer['gcode_macro _global_var'].preheat_temp} BED_TEMP={mesh_calibrate_temp} WAIT=False
    RESPOND TYPE=echo MSG="CHECK HEATING!"
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G4 P2000
        G28
    {% endif %}
    M117 QUAD GANTRYLEVEL
    RESPOND TYPE=echo MSG="QGL START"
    QUAD_GANTRY_LEVEL_BASE
    G4 P2000
    G28 Z
    RESPOND TYPE=echo MSG="QGL END"
    {% if printer.print_stats.state != "printing" %}
        TURN_OFF_HEATERS
        RESPOND TYPE=echo MSG="TURN OFF HEATERS"
    {% endif %}

[gcode_macro PROBE_CALIBRATE]
description: CALIBRATES THE PROBE'S Z-OFFSET WITH BED PREHEATING AND HOMING
rename_existing: PROBE_CALIBRATE_BASE
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR: GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    LCD_YELLOW
    #NOZZLE_LED_PURPLE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
    M117 PROBE CALIBRATE
    _SET_TEMPERATURE EXTRUDER_TEMP={printer['gcode_macro _global_var'].preheat_temp} BED_TEMP={printer['gcode_macro _global_var'].calibrate_bed_temp} WAIT=True
    RESPOND TYPE=echo MSG="ZOFFSET HEATING"
    G4 P2000
    G28
    RESPOND TYPE=echo MSG="PROBE_CALIBRATE"
    PROBE_CALIBRATE_BASE
    TESTZ z=-4

[gcode_macro BED_MESH_CALIBRATE]
description: CREATES A BED MESH PROFILE WITH ADAPTIVE PROBING AND PREHEATING
rename_existing: BED_MESH_CALIBRATE_BASE
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR: GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
   {% endif %}
    RESPOND TYPE=echo MSG="BED MESH CAL"
    LCD_YELLOW
    #NOZZLE_LED_PURPLE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
    M117 BED MESH AREA
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
    _SET_TEMPERATURE EXTRUDER_TEMP={printer['gcode_macro _global_var'].preheat_temp} BED_TEMP={mesh_calibrate_temp} WAIT=True
    RESPOND TYPE=echo MSG="MESH HEATED"
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G4 P2000
        G28
    {% endif %}
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE_BASE ADAPTIVE=1
    TURN_OFF_HEATERS
    RESPOND TYPE=echo MSG="TURN OFF HEATERS"
    M117 BED MESH DONE

[gcode_macro G34]
description: MANUALLY TRIGGERS QUAD GANTRY LEVELING AND MOVES TO A SAFE POSITION
gcode:
    LCD_YELLOW # MOD LCD calibrate color
    M117 MANUAL QGL
    BED_MESH_CLEAR
    G4 P2000 # MOD Add pause for steppers
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
      G28
    {% else %}
      G28 Z
    {% endif %}
    QUAD_GANTRY_LEVEL 
    G4 P2000 # MOD Add pause for steppers
    G28 Z
    G0 X175 Y175 Z30 F3600
    M117 G34 FINISHED

[delayed_gcode bed_mesh_init]
initial_duration: .01
gcode:
    BED_MESH_PROFILE LOAD=default

[delayed_gcode _print_start_wait]
gcode:
    {% if printer['gcode_macro START_PRINT'].state == 'Heating'%}
        RESPOND TYPE=echo MSG="PREPARE->HEATING!"
    {% elif printer['gcode_macro START_PRINT'].state == 'Start' %}
        RESPOND TYPE=echo MSG="HEATING->START!"
    {% endif %}
    {% if printer['gcode_macro START_PRINT'].execute|lower != 'false' %}
        START_PRINT
    {% endif %}

[gcode_macro START_PRINT]
description: INITIALIZES A PRINT JOB BY HOMING, HEATING, LEVELING, AND CLEANING THE NOZZLE PRIOR PRINT
variable_state: 'Prepare'
gcode:
    {% set FILE_NAME = printer.print_stats.filename|truncate(16, true, '') %}

    # ----- Start Slicer parameters and safe fallbacks -----
    # If Orca somehow forgets to send the temps (very rare), we don’t want the nozzle to go to 0 °C
    # → fallback to 235 °C nozzle and 60 °C bed (same values you already use in LOAD_FILAMENT etc.)
    {% set extruder_final = params.EXTRUDER_TEMP|default(235)|int %}
    {% set bed_final      = params.BED_TEMP|default(60)|int %}
    # ----- End Slicer parameters and safe fallbacks -----

    ; Init preheating and prepare
    {% if state == 'Prepare' %}
        LCD_ORANGE
        #NOZZLE_LED_WHITE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
        RESPOND TYPE=echo MSG="START PRINT: {FILE_NAME} | Nozzle→{extruder_final}°C Bed→{bed_final}°C"
        M400
        CLEAR_PAUSE
        G90
        {% set homed_status = 'No' if printer.toolhead.homed_axes|lower == '' else printer.toolhead.homed_axes %}
        RESPOND TYPE=echo MSG="START_PRINT: MODE=G90, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, STATE={printer.print_stats.state}, HOMED={homed_status}"
        RESPOND TYPE=echo MSG="PREPARE!"
        M117 INIT {FILE_NAME}
        RESPOND TYPE=echo MSG="START_PRINT: SET PREHEAT EXTRUDER={printer["gcode_macro _global_var"].preheat_temp}°C, BED={printer["gcode_macro _global_var"].calibrate_bed_temp}°C"
        _SET_TEMPERATURE EXTRUDER_TEMP={printer["gcode_macro _global_var"].preheat_temp} BED_TEMP={printer["gcode_macro _global_var"].calibrate_bed_temp} WAIT=False
        ; Homing if needed
        {% if printer.toolhead.homed_axes != "xyz" %}
            G4 P2000
            G28
            RESPOND TYPE=echo MSG="AXES HOMED, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, HOMED={printer.toolhead.homed_axes}"
        {% endif %}
        ; Quad Gantry Leveling
        RESPOND TYPE=echo MSG="INIT QGL"
        M117 INIT QGL
        {% if printer.quad_gantry_level.applied|lower != 'true' %}
            QUAD_GANTRY_LEVEL
            RESPOND TYPE=echo MSG="START_PRINT: POST-QGL, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, HOMED={printer.toolhead.homed_axes}"
        {% endif %}
        ; Bed mesh leveling
        M117 BED MESH...
        BED_MESH_CALIBRATE ADAPTIVE=1
        RESPOND TYPE=echo MSG="START_PRINT: POST-BED_MESH, PROFILE={printer.bed_mesh.profile_name|default('N/A')}, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}"
        ; Cleaning nozzle prior printing
        M117 CLEAN NOZZLE
        CLEAN_NOZZLE
        RESPOND TYPE=echo MSG="START_PRINT: POST-CLEAN_NOZZLE, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}"
        ; Sealing nozzle on bed prior heating to target temperature
        LCD_GREEN
        G1 Z0.0 F300
        RESPOND TYPE=echo MSG="START_PRINT: POST-G1 Z0.0, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}"
        M117 READY TO PRINT
        ; Final temperatures from slicer (or safe fallbacks)
        RESPOND TYPE=echo MSG="START HEATING, EXTRUDER={extruder_final}°C, BED={bed_final}°C, Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}"
        RESPOND TYPE=echo MSG="START HEATING, EXTRUDER={extruder_final}°C, BED={bed_final}°C"
        _SET_TEMPERATURE EXTRUDER_TEMP={extruder_final} BED_TEMP={bed_final} WAIT=True

        ; ─────────────────────────────
        ;  Final wipe + safe raise (your safety step)
        ; ────────────────────────────────
        G90
        G1 Z1.0 F600            ; nozzle raise
        M400
        G1 X0 Y0 F9000          ; front-left corner
        M400
        G1 Z1.2 F600            ; wipe height
        M400
        G1 Y4 F7000         ; fast wipe
        G1 Z2.4 F600            ; final safe height → protects presliced Sovol USB files too
        M400
        G1 Y40 F7000         ; fast wipe
        M400
        RESPOND TYPE=echo MSG="START_PRINT: Wipe & raise done – print begins now"
        ; ─────────────────────────────

        SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE="'Start'"
        UPDATE_DELAYED_GCODE ID=_print_start_wait DURATION=0.5

    {% elif state == 'Start' %}
        LCD_GREEN
        save_last_file
        RESPOND TYPE=echo MSG="START! Z_POS={printer.gcode_move.position.z}, Z_OFFSET={printer.configfile.settings.probe.z_offset|default('N/A')}, STATE={printer.print_stats.state}"
        M117 {FILE_NAME}
    {% endif %}

[gcode_macro END_PRINT]
description: FINALIZES A PRINT JOB BY RETRACTING FILAMENT, PARKING THE TOOLHEAD, AND TURNING OFF HEATERS AND FANS
variable_state: 'normal'
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR: GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp = printer.configfile.settings['extruder'].min_extrude_temp %}

    M400
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'

    G91
    {% if printer['filament_switch_sensor filament_sensor'].enable == True and
          printer['filament_switch_sensor filament_sensor'].filament_detected == True
    %}
        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
              printer.extruder.temperature >= e_mintemp
        %}
            G1 E-2 F2700
            G1 E-2 Z0.2 F2400
        {% endif %}
    {% endif %}

    {% if (printer.gcode_move.position.z + 10) < z_max %}
        G1 Z+10 F3000
    {% else %}
        G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X0 Y360 F9000
    TURN_OFF_HEATERS
    M117 NOZZLE COOLING!
    RESPOND TYPE=echo MSG="TURN OFF HEATERS"
    SET_FAN_SPEED FAN=fan0 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    SET_FAN_SPEED FAN=fan1 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    G4 P{printer['gcode_macro _global_var'].post_print_cool_time} # MOD Extra nozzle cooling after print
    _ALL_FAN_OFF
    M84 X Y Z E  

    M220 S100
    M221 S100

    LCD_DEFAULT # MOD LCD Print finished - return to default
    M117 PRINT FINISHED!
    #NOZZLE_LED_OFF #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
    RESPOND TYPE=echo MSG="ALL FANS AND HEATERS TURNED OFF"
    BEEP COUNT=3 # MOD acoustic end signal
    CLEAR_PAUSE
    PRINT_END
    RESPOND TYPE=echo MSG="PRINT FINISHED!"

[gcode_macro CANCEL_PRINT]
description: CANCELS A PRINT JOB, RETRACTS FILAMENT, PARKS THE TOOLHEAD, AND SIGNALS CANCELATION
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR: GLOBAL VAR
        LCD_RED
        CANCEL_PRINT_BASE
    {% endif %}
    {% set x_park = printer['gcode_macro _global_var'].cancel_park.x|float %}
    {% set y_park = printer['gcode_macro _global_var'].cancel_park.y|float %}
    {% set z_park = printer['gcode_macro _global_var'].cancel_park.z|float %}
    {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
    {% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set e_mintemp = printer.configfile.settings['extruder'].min_extrude_temp %}

    CANCEL_PRINT_BASE
    RESPOND TYPE=echo MSG="CANCELING PRINT!"
    M117 CANCEL PRINT!
    
    G91
    {% if printer['filament_switch_sensor filament_sensor'].enable == True and 
          printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
              printer.extruder.temperature >= e_mintemp %}
            G1 E-{e_restract} F500
        {% else %}
            RESPOND TYPE=echo MSG="NOZZLE NOT HOT"
        {% endif %}
    {% endif %}

    {% if (printer.gcode_move.position.z + 10) < z_lift_max %}
        G1 Z+10 F3000
    {% else %}
        G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X{x_park} Y{y_park} F9000
    TURN_OFF_HEATERS
    RESPOND TYPE=echo MSG="TURN OFF HEATERS"
    SET_FAN_SPEED FAN=fan0 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    SET_FAN_SPEED FAN=fan1 SPEED={printer['gcode_macro _global_var'].post_print_fan_speed} # MOD Extra nozzle cooling after print
    G4 P{printer['gcode_macro _global_var'].post_print_cool_time} # MOD Extra nozzle cooling after print
    _ALL_FAN_OFF
    LCD_RED # MOD LCD cancel color
    #NOZZLE_LED_RED #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
    BEEP COUNT=5
    CLEAR_PAUSE
    M84 X Y Z E
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    RESPOND TYPE=echo MSG="Power Loss Recovery of this print dismissed"
    M117 CANCELED!
    RESPOND TYPE=echo MSG="CANCEL PRINT DONE!"
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'

[gcode_macro PAUSE]
description: PAUSES THE PRINT, PARKS THE TOOLHEAD, AND OPTIONALLY HANDLES FILAMENT CHANGES.
rename_existing: PAUSE_BASE
variable_state: 'normal'
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR: GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    {% if printer.pause_resume.is_paused == False %}
        {% set x_park = printer['gcode_macro _global_var'].pause_park.x|float %}
        {% set y_park = printer['gcode_macro _global_var'].pause_park.y|float %}
        {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
        {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
        {% set state = params.STATE|default('normal') %}
        
        RESPOND TYPE=echo MSG="PRINT PAUSED!"
        LCD_CYAN
        #NOZZLE_LED_WHITE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
        PAUSE_BASE
        RESPOND TYPE=echo MSG="PAUSING PRINT!"
        M117 PAUSING WAIT!
        G91
        {% if (printer.gcode_move.position.z + 5) < z_lift_max %}
            G1 Z+5 F3000
        {% else %}
            G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
        {% endif %}
        G90
        {% if printer.gcode_move.position.x != x_park or
              printer.gcode_move.position.y != y_park %}
            G1 X{x_park} Y{y_park} F{printer['gcode_macro _global_var'].pause_resume_travel_speed * 60}
        {% endif %}

        M104 S{printer.extruder.target}
    
        {% if state == 'normal' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                {% if printer['filament_switch_sensor filament_sensor'].enable == True and 
                      printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
                    G91
                    G1 E-{e_restract} F300
                    G90
                {% elif printer['filament_switch_sensor filament_sensor'].enable == True and 
                        printer['filament_switch_sensor filament_sensor'].filament_detected != True %}
                    G91
                    G1 E+95 F300
                    G1 E-10 F1500
                    G1 E-20 F600
                    M400
                    G4 P3000
                    G1 E-50 F300 
                    G90
                {% endif %}
            {% endif %}
        {% elif state == 'filament_change' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                G91
                G1 E+25 F300
                G1 E-10 F1500
                G1 E-20 F600
                M400
                G4 P3000
                G1 E-50 F300 
                G90
            {% endif %}
        {% endif %}
    {% endif %}
    M117 PAUSE NOW!
    BEEP COUNT=1 # MOD acoustic pause signal

[delayed_gcode _resume_wait]
gcode:
    {% if printer['gcode_macro RESUME'].execute|lower != 'false' %}
        RESUME
    {% endif %}


[gcode_macro RESUME]
description: RESUMES A PAUSED PRINT, ENSURING FILAMENT IS PRESENT
rename_existing: RESUME_BASE
variable_state: 'normal'
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 ERROR RESUME
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
    {% set extruder_target_temp = printer.extruder.target|int %}
    {% set FILE_NAME = printer.print_stats.filename %}
    {% set state = params.STATE|default('normal') %}
    ; Direct sensor check
    {% if 'filament_switch_sensor filament_sensor' in printer %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
        G4 P2000
        QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
        {% set direct_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
        RESPOND TYPE=echo MSG="SENSOR D: {direct_detected}"
    {% else %}
        {% set direct_detected = True %}
    {% endif %}
    CHECK_FILAMENT_SENSOR CANCEL=False
    {% if not direct_detected %}
        RESPOND TYPE=echo MSG="INSERT FILAMENT!"
        M117 INSERT FILAMENT
        LCD_RED
    BEEP COUNT=1
    {% else %}
        {% if state == 'filament_change' %}
            {% if printer.extruder.temperature + 5 < printer.extruder.target %}
                M104 S{extruder_target_temp}
                RESPOND TYPE=echo MSG="HEATING TO {extruder_target_temp}°C."
                M117 NOZZLE HEATING
                M109 S{extruder_target_temp}
            {% endif %}
            G91
            G1 E30 F300
            G1 E10 F150
            G90
        {% elif state == 'normal' %}
            G91
            G1 E{e_restract} F300
            G90
        {% endif %}
        RESPOND TYPE=echo MSG="PRINT RESUMING!"
        M117 RESUME {FILE_NAME}
        LCD_GREEN
        #NOZZLE_LED_WHITE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
        SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
        G4 P2000
        RESUME_BASE
    {% endif %}

[gcode_macro LOAD_FILAMENT]
description: LOADS FILAMENT BY HEATING AND EXTRUDING, WITH FILAMENT SENSOR CHECK
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 NO GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    LCD_PURPLE
    #NOZZLE_LED_PURPLE #UNCOMMENTED REMOVE # IN THE BEGINNING IF NEOPIXEL LED INSTALLED
    RESPOND TYPE=echo MSG="LOAD CHECK&START"
    M117 LOAD CHECK&START
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp = printer.extruder.target|int %}
    {% if printer.print_stats.state != "printing" %}
        {% if 'filament_switch_sensor filament_sensor' in printer %}
            SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
            G4 P2000
            QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
            {% set direct_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
            RESPOND TYPE=echo MSG="SENSOR D: {direct_detected}"
        {% else %}
            {% set direct_detected = True %}
        {% endif %}
        CHECK_FILAMENT_SENSOR CANCEL=False
        {% if not direct_detected %}
            RESPOND TYPE=echo MSG="LOAD ABORTED!"
            M117 LOAD ABORTED!
            LCD_RED
            BEEP COUNT=5
            G4 P5000
            M117 INSERT FILAMENT!
            G4 P5000
            {% if 'filament_switch_sensor filament_sensor' in printer %}
                SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
                G4 P2000
                QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
                {% set retry_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
                RESPOND TYPE=echo MSG="SENSOR D: {retry_detected}"
                {% if not retry_detected %}
                    RESPOND TYPE=echo MSG="NO FILAMENT!"
                    M117 NO FILAMENT!
                    LCD_RED
                    BEEP COUNT=5
                {% else %}
                    RESPOND TYPE=echo MSG="FILAMENT OK"
                    M117 FILAMENT OK
                {% endif %}
            {% else %}
                {% set retry_detected = True %}
            {% endif %}
        {% else %}
            {% set retry_detected = True %}
        {% endif %}
        {% if retry_detected %}
            RESPOND TYPE=echo MSG="HEAT START"
            M117 HEAT START
            {% if printer.print_stats.state != "paused" %}
                _SET_TEMPERATURE EXTRUDER_TEMP={extruder_temp} WAIT=True
                RESPOND TYPE=echo MSG="HEATING: {extruder_temp}°C"
            {% else %}
                {% if printer.extruder.target == 0 %}
                    _SET_TEMPERATURE EXTRUDER_TEMP={extruder_temp} WAIT=True
                    RESPOND TYPE=echo MSG="HEATING: {extruder_temp}°C"
                {% else %}
                    _SET_TEMPERATURE EXTRUDER_TEMP={printer.extruder.target} WAIT=True
                    RESPOND TYPE=echo MSG="HEATING: {printer.extruder.target}°C"
                {% endif %}
            {% endif %}
            {% if 'filament_switch_sensor filament_sensor' in printer %}
                SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
                G4 P2000
                QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
                {% set pre_extrude_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
                RESPOND TYPE=echo MSG="SENSOR D: {pre_extrude_detected}"
            {% else %}
                {% set pre_extrude_detected = True %}
            {% endif %}
            CHECK_FILAMENT_SENSOR CANCEL=False
            {% if not pre_extrude_detected %}
                RESPOND TYPE=echo MSG="NO FILAMENT!"
                M117 LOAD ABORTED
                LCD_RED
                BEEP COUNT=5
            {% else %}
                RESPOND TYPE=echo MSG="EXTRUDING..."
                M117 EXTRUDING...
                G91
                G1 E45 F300
                G1 E30 F150
                G90
                M400
                CHECK_FILAMENT_SENSOR CANCEL=False
                {% if 'filament_switch_sensor filament_sensor' in printer %}
                    SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
                    G4 P2000
                    QUERY_FILAMENT_SENSOR SENSOR=filament_sensor
                    {% set post_extrude_detected = printer['filament_switch_sensor filament_sensor'].filament_detected %}
                    RESPOND TYPE=echo MSG="SENSOR D: {post_extrude_detected}"
                {% else %}
                    {% set post_extrude_detected = True %}
                {% endif %}
                {% if not post_extrude_detected %}
                    RESPOND TYPE=echo MSG="LOAD FAILED"
                    M117 LOAD FAILED
                    LCD_RED
                    BEEP COUNT=5
                {% else %}
                    RESPOND TYPE=echo MSG="EXTRUDE FINISHED"
                    M117 EXTRUDE FINISHED
                {% endif %}
            {% endif %}
            M400
            {% if current_target_temp == 0 or printer.print_stats.state != "paused" %}
                _SET_TEMPERATURE EXTRUDER_TEMP=0 WAIT=False
                RESPOND TYPE=echo MSG="COOLING EXTRUDER"
            {% endif %}
        {% endif %}
    {% else %}
        RESPOND TYPE=echo MSG="NO LOAD: PRINTING"
        M117 NO LOAD: PRINTING
        LCD_RED
    {% endif %}
    M117 LOAD END - OK
    RESPOND TYPE=echo MSG="FILAMENT LOAD OK"
    BEEP COUNT=1
    
[gcode_macro UNLOAD_FILAMENT]
description: UNLOADS FILAMENT BY HEATING AND RETRACTING
gcode:
    {% if 'gcode_macro _global_var' not in printer %}
        RESPOND TYPE=echo MSG="ERROR: _global_var MISSING!"
        M117 NO GLOBAL VAR
        LCD_RED
        CANCEL_PRINT
    {% endif %}
    LCD_PURPLE
    NOZZLE_LED_PURPLE
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp = printer.extruder.target|int %}
    {% if printer.print_stats.state != "printing" %}
        {% if printer.print_stats.state != "paused" %}
            _SET_TEMPERATURE EXTRUDER_TEMP={extruder_temp} WAIT=True
            RESPOND TYPE=echo MSG="HEATING: {extruder_temp}°C"
        {% else %}
            {% if printer.extruder.target == 0 %}
                _SET_TEMPERATURE EXTRUDER_TEMP={extruder_temp} WAIT=True
                RESPOND TYPE=echo MSG="HEATING: {extruder_temp}°C"
            {% else %}
                _SET_TEMPERATURE EXTRUDER_TEMP={printer.extruder.target} WAIT=True
                RESPOND TYPE=echo MSG="HEATING: {printer.extruder.target}°C"
            {% endif %}
        {% endif %}
        M117 RETRACTING
        G91
        G1 E+25 F300
        G1 E-10 F1500
        G1 E-20 F600
        M400
        G4 P3000
        G1 E-50 F300
        G90
        M400
        M117 RETRACT FINISH
        RESPOND TYPE=echo MSG="RETRACT FILAMENT"
        BEEP COUNT=1
        M400
        {% if current_target_temp == 0 or printer.print_stats.state != "paused" %}
            _SET_TEMPERATURE EXTRUDER_TEMP=0 WAIT=False
            RESPOND TYPE=echo MSG="COOLING EXTRUDER"
        {% endif %}
    {% else %}
        RESPOND TYPE=echo MSG="NO UNLOAD! PRINTING!"
        M117 NO UNLOAD PRINTING
    {% endif %}
    BEEP COUNT=1

[gcode_macro M109]
description: SETS AND WAITS FOR EXTRUDER TEMPERATURE WITH TIMEOUT
rename_existing: M99109
gcode:
    {% set s = params.S|float %}
    RESPOND TYPE=echo MSG="SET NOZZLE {s}°C"
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-1} MAXIMUM={s+1} TIMEOUT={printer['gcode_macro _global_var'].timeout_extruder}
        G4 P500
        RESPOND TYPE=echo MSG="TEMP REACHED: {s}°C"
    {% else %}
        RESPOND TYPE=echo MSG="TURNING OFF HEATER"
    {% endif %}

[gcode_macro M190]
description: SETS AND WAITS FOR BED TEMPERATURE WITH TIMEOUT
rename_existing: M99190
gcode:
    {% set s = params.S|float %}
    RESPOND TYPE=echo MSG="SET BED {s}°C"
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+1} TIMEOUT={printer['gcode_macro _global_var'].timeout_bed}
        RESPOND TYPE=echo MSG="BED TEMP OK: {s}°C"
    {% else %}
        RESPOND TYPE=echo MSG="NO BED HEATING"
    {% endif %}

[gcode_macro M106]
description: SETS THE SPEED FOR COOLING FANS (fan0, fan1 and fan3)
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% set speed = (params.S|float / 255 if params.S is defined else 1.0) %}
    {% if fan == 'fan3'%}
            SET_FAN_SPEED FAN={fan} SPEED={speed}
    {% else %}
        SET_FAN_SPEED FAN={'fan0'} SPEED={speed}
        SET_FAN_SPEED FAN={'fan1'} SPEED={speed}
    {% endif %}
    
[gcode_macro M107]
description: TURNS OFF COOLING FANS (fan0, fan1, and fan3)
gcode:
    {% set fan = 'fan' + (params.P|int if params.P is defined else 0)|string %}
    {% if fan == 'fan3'%}
            SET_FAN_SPEED FAN={fan} SPEED=0
    {% else %}
        SET_FAN_SPEED FAN={'fan0'} SPEED=0
        SET_FAN_SPEED FAN={'fan1'} SPEED=0
    {% endif %}
    
[gcode_macro M600]
description: INITIATES A FILAMENT CHANGE BY PAUSING THE PRINT AND SETTING FILAMENT_CHANGE STATE
gcode:
    LCD_CYAN #MOD
    PAUSE STATE=filament_change

#UNCOMMENTED REMOVE # IN THIS BLOCK IF NEOPIXEL LED INSTALLED
#[gcode_macro NOZZLE_LED_WHITE]
#description: SET NEOPIXEL TO LOW-BRIGHTNESS WHITE
#gcode:
#    SET_LED LED=hotend_rgb RED=0.065 GREEN=0.065 BLUE=0.065 WHITE=0.3
#
#[gcode_macro NOZZLE_LED_PURPLE]
#description: SET NEOPIXEL TO MEDIUM-BRIGHTNESS PURPLE
#gcode:
#    SET_LED LED=hotend_rgb RED=0.3 GREEN=0.0 BLUE=0.3 WHITE=0.0
#
#[gcode_macro NOZZLE_LED_RED]
#description: SET NEOPIXEL TO HIGH-BRIGHTNESS RED
#gcode:
#    SET_LED LED=hotend_rgb RED=0.6 GREEN=0.0 BLUE=0.0 WHITE=0.0
#
#[gcode_macro NOZZLE_LED_OFF]
#description: TURN OFF NEOPIXEL LED
#gcode:
#    SET_LED LED=hotend_rgb RED=0.0 GREEN=0.0 BLUE=0.0 WHITE=0.0

#-----------MOD START - LED MACROS TO SET LCD COLORS------------------#

[gcode_macro LCD_DEFAULT]
description: SETS THE LCD DISPLAY TO CUSTOM COLORS
gcode:
    SET_LED LED=Screen_Colour RED=0.5 GREEN=0.4 BLUE=0.7 INDEX=1 TRANSMIT=0
    SET_LED LED=Screen_Colour RED=0.5 GREEN=0.4 BLUE=0.7 INDEX=2 TRANSMIT=0
    SET_LED LED=Screen_Colour RED=0.5 GREEN=0.4 BLUE=0.7 INDEX=3

[gcode_macro LCD_RED]
gcode:
    SET_LED LED=Screen_Colour RED=1 GREEN=0 BLUE=0 TRANSMIT=1

[gcode_macro LCD_ORANGE]
gcode:
    SET_LED LED=Screen_Colour RED=1 GREEN=0.1 BLUE=0 TRANSMIT=1

[gcode_macro LCD_GREEN]
gcode:
    SET_LED LED=Screen_Colour RED=0 GREEN=1 BLUE=0 TRANSMIT=1

[gcode_macro LCD_BLUE]
gcode:
    SET_LED LED=Screen_Colour RED=0 GREEN=0 BLUE=1 TRANSMIT=1

[gcode_macro LCD_PURPLE]
gcode:
    SET_LED LED=Screen_Colour RED=1 GREEN=0 BLUE=1 TRANSMIT=1

[gcode_macro LCD_CYAN]
gcode:
    SET_LED LED=Screen_Colour RED=0 GREEN=1 BLUE=1 TRANSMIT=1

[gcode_macro LCD_YELLOW]
gcode:
    SET_LED LED=Screen_Colour RED=1 GREEN=0.9 BLUE=0.05 TRANSMIT=1

[gcode_macro LCD_BLACK]
gcode:
    SET_LED LED=Screen_Colour RED=0 GREEN=0 BLUE=0 TRANSMIT=1

[gcode_macro LCD_WHITE]
gcode:
    SET_LED LED=Screen_Colour RED=1 GREEN=1 BLUE=0.80 TRANSMIT=1
#-----------MOD END - LED MACROS TO SET LCD COLORS------------------#
